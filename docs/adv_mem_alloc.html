<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>bs::f docs - Advanced memory allocation</title>
<link rel="icon" type="image/png" href="logo.png">
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href='https://fonts.googleapis.com/css?family=Lato:normal,bold|Cabin:normal,bold' rel='stylesheet' type='text/css'>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="SemanticUI/semantic.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxystyle.css" rel="stylesheet" type="text/css"/>
<link href="SemanticUI/semantic.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="everything">
	<div class="ui inverted vertical center aligned segment" id="menuSegment">
		<div class="ui container">
			<div class="ui inverted mainmenu menu">
				<a href="https://www.bsframework.io"><div class="item" id="logoItem"><img class="ui image" id="logo" src="logoHeader.png"></div></a>
				<div class="right menu">
					<a class="borderless item" href="https://www.bsframework.io">Home</a>
					<a class="item" href="https://www.bsframework.io/download.html">Download</a>
					<a class="item" href="https://discourse.bsframework.io">Community</a>
					<a class="active item" href="https://www.bsframework.io/docs/index.html">Documentation</a>
					<a class="item" href="https://github.com/gamefoundry/bsf"><i class="github icon"></i>GitHub</a>
				</div>
			</div>
		</div>
	</div>	
	<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Advanced memory allocation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#advMemAlloc_a">Stack allocator</a></li>
<li class="level1"><a href="#advMemAlloc_b">Frame allocator</a><ul><li class="level2"><a href="#advMemAlloc_b_a">Local frame allocators</a></li>
<li class="level2"><a href="#advMemAlloc_b_b">Container allocators</a></li>
</ul>
</li>
<li class="level1"><a href="#advMemAlloc_c">Pool allocator</a></li>
<li class="level1"><a href="#advMemAlloc_d">Static allocator</a></li>
</ul>
</div>
<div class="textblock"><p>bs::f allows you to allocate memory in various ways, so you can have fast memory allocations for many situations. We have already shown how to allocate memory for the general case, using <b>bs_new</b> / <b>bs_delete</b>, <b>bs_alloc</b>, <b>bs_free</b> and shown how to use shared pointers. But allocating memory using these general purpose allocators can be expensive. Therefore it is beneficial to have more specialized allocator types that have certain restrictions, but allocate memory with almost no overhead.</p>
<h1><a class="anchor" id="advMemAlloc_a"></a>
Stack allocator</h1>
<p>Stack allocator allows you to allocate memory quickly and with zero fragmentation. It comes with a restriction that it can only deallocate memory in the opposite order it was allocated. This usually only makes it suitable for temporary allocations within a single method, where you can guarantee the proper order.</p>
<p>Use <a class="el" href="group___memory.html#ga90acb2cfce60ceef66b28d426976c6e2">bs_stack_alloc()</a> / <a class="el" href="group___memory.html#ga9e8c54648877a868f0bf83378afc6133">bs_stack_free()</a> or <a class="el" href="group___memory.html#ga6bbf50949ca59d848c31464b128b1d0d">bs_stack_new()</a> / <a class="el" href="group___memory.html#ga5377cdd5d095cefe6c394d40a071455b">bs_stack_delete()</a> to allocate/free memory using the stack allocator.</p>
<div class="fragment"><div class="line">UINT8* buffer = <a class="code" href="group___memory.html#ga90acb2cfce60ceef66b28d426976c6e2">bs_stack_alloc</a>(1024);</div><div class="line">... <span class="keywordflow">do</span> something with buffer ...</div><div class="line">UINT8* buffer2 = <a class="code" href="group___memory.html#ga90acb2cfce60ceef66b28d426976c6e2">bs_stack_alloc</a>(512);</div><div class="line">... <span class="keywordflow">do</span> something with buffer2 ...</div><div class="line">bs_stack_free(buffer2); <span class="comment">// Must free buffer2 first!</span></div><div class="line"><a class="code" href="group___memory.html#ga9e8c54648877a868f0bf83378afc6133">bs_stack_free</a>(buffer);</div></div><!-- fragment --><h1><a class="anchor" id="advMemAlloc_b"></a>
Frame allocator</h1>
<p>Frame allocator segments all allocated memory into <em>frames</em>. These frames are stored in a stack-like fashion, and must be deallocated in the opposite order they were allocated, similar to how the stack allocator works. However there are no restrictions on memory deallocation within a single frame, which makes this type of allocator usable in many more situations than the stack allocator. Its downside is that it doesn't deallocate memory until the whole frame is freed - which means it usually uses up more memory than it would otherwise need to.</p>
<p>Use <a class="el" href="group___memory.html#ga3293dd38212269dafc81577a543ac81a">bs_frame_mark()</a> to start a new frame, and use <a class="el" href="group___memory.html#ga85036849159c6716e001f4fae97c6488">bs_frame_clear()</a> to free all of the memory in a single frame. The frames have to be released in opposite order they were created.</p>
<p>Once you have started a frame use <a class="el" href="group___memory.html#ga405c0dc20a2c748eb66210a217bc484e">bs_frame_alloc()</a> / <a class="el" href="group___memory.html#gabcad7521458d565efa07349c6331a579">bs_frame_free()</a> or <a class="el" href="group___memory.html#ga32c4fa2bbfb04261850c43822a2739af">bs_frame_new()</a> / <a class="el" href="group___memory.html#ga6ff34b8abcaa5a9fd073c825a0ea46d5">bs_frame_delete()</a> to allocate/free memory using the frame allocator. Calls to <b><a class="el" href="group___memory.html#gabcad7521458d565efa07349c6331a579" title="Deallocates memory allocated with the global frame allocator. ">bs_frame_free()</a></b> / <b><a class="el" href="group___memory.html#ga6ff34b8abcaa5a9fd073c825a0ea46d5" title="Destructs and deallocates an object allocated with the global frame allocator. ">bs_frame_delete()</a></b> are required even through the frame allocator doesn't process individual deallocations, and this is used primarily for debug purposes.</p>
<div class="fragment"><div class="line"><span class="comment">// Mark a new frame</span></div><div class="line"><a class="code" href="group___memory.html#ga3293dd38212269dafc81577a543ac81a">bs_frame_mark</a>();</div><div class="line">UINT8* buffer = <a class="code" href="group___memory.html#ga405c0dc20a2c748eb66210a217bc484e">bs_frame_alloc</a>(1024);</div><div class="line">... <span class="keywordflow">do</span> something with buffer ...</div><div class="line">UINT8* buffer2 = <a class="code" href="group___memory.html#ga405c0dc20a2c748eb66210a217bc484e">bs_frame_alloc</a>(512);</div><div class="line">... <span class="keywordflow">do</span> something with buffer2 ...</div><div class="line">bs_frame_free(buffer); <span class="comment">// Only does some checks in debug mode, doesn&#39;t actually free anything</span></div><div class="line"><a class="code" href="group___memory.html#gabcad7521458d565efa07349c6331a579">bs_frame_free</a>(buffer2); <span class="comment">// Only does some checks in debug mode, doesn&#39;t actually free anything</span></div><div class="line"><a class="code" href="group___memory.html#ga85036849159c6716e001f4fae97c6488">bs_frame_clear</a>(); <span class="comment">// Frees memory for both buffers</span></div></div><!-- fragment --><h2><a class="anchor" id="advMemAlloc_b_a"></a>
Local frame allocators</h2>
<p>You can also create your own frame allocators by constructing a <a class="el" href="classbs_1_1_frame_alloc.html">FrameAlloc</a> object and calling memory management methods on it directly. While the global frame allocator methods are mostly useful for temporary allocations within a single method, creating your own frame allocator allows you to share frame allocated memory between different objects and persist it for a longer period of time.</p>
<p>For example if you are running some complex algorithm involving multiple classes you might create a frame allocator to be used throughout the algorithm, and then just free all the memory at once when the algorithm finishes.</p>
<div class="fragment"><div class="line">FrameAlloc alloc;</div><div class="line">alloc.markFrame();</div><div class="line">UINT8* buffer = alloc.alloc(1024);</div><div class="line">... <span class="keywordflow">do</span> something with buffer ...</div><div class="line">UINT8* buffer2 = alloc.alloc(512);</div><div class="line">... <span class="keywordflow">do</span> something with buffer2 ...</div><div class="line">alloc.dealloc(buffer);</div><div class="line">alloc.dealloc(buffer2);</div><div class="line">alloc.clear();</div></div><!-- fragment --><h2><a class="anchor" id="advMemAlloc_b_b"></a>
Container allocators</h2>
<p>You may also use frame allocator to allocate containers like <b>String</b>, <b>Vector</b> or <b>Map</b>. Simply mark the frame as in the above example, and then use the following container alternatives: <a class="el" href="group___string.html#gad5ba86fc2c60a7dec2e22553e0bc20d3">FrameString</a>, <a class="el" href="group___memory.html#ga4503d77ccc0b655bb56f1d90746b8c51">FrameVector</a> or <a class="el" href="group___memory.html#gaec13991a0574c7ec1040f545535dd5ea">FrameMap</a> (most other containers also have a <em>Frame</em> version). For example:</p>
<div class="fragment"><div class="line"><span class="comment">// Mark a new frame</span></div><div class="line"><a class="code" href="group___memory.html#ga3293dd38212269dafc81577a543ac81a">bs_frame_mark</a>();</div><div class="line">{</div><div class="line">    FrameVector&lt;UINT8&gt; vector;</div><div class="line">    ... populate the vector ... <span class="comment">// No dynamic memory allocation cost as with a normal Vector</span></div><div class="line">} <span class="comment">// Block making sure the vector is deallocated before calling bs_frame_clear</span></div><div class="line"><a class="code" href="group___memory.html#ga85036849159c6716e001f4fae97c6488">bs_frame_clear</a>(); <span class="comment">// Frees memory for the vector</span></div></div><!-- fragment --><h1><a class="anchor" id="advMemAlloc_c"></a>
Pool allocator</h1>
<p><a class="el" href="classbs_1_1_pool_alloc.html">PoolAlloc&lt;ElemSize, ElemsPerBlock&gt;</a> is a specialized type of allocator that can be used for permanent allocations. It performs fast allocations with very low fragmentation. Its downside is that it is only able to allocate memory in chunks of specific size, making it suitable for creation of many instances of the same object.</p>
<p>When creating it you need to specify the size of the object you need to allocate, as well as the default number of objects it can contain. If the allocator exceeds the number of objects it can contain it will dynamically allocate another block capable of handling more objects.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>MyData</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> foo;</div><div class="line">    <span class="keywordtype">float</span> bar;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// Pool allocator capable of holding 128 objects of type MyData</span></div><div class="line">PoolAlloc&lt;sizeof(MyData), 128&gt; allocator;</div><div class="line"></div><div class="line"><span class="comment">// Allocate a single object from the pool</span></div><div class="line">MyData* obj = (MyData*)allocator.alloc();</div><div class="line"></div><div class="line"><span class="comment">// ... do something with the data ...</span></div><div class="line"></div><div class="line"><span class="comment">// When done return the memory back to the pool</span></div><div class="line">allocator.free(obj);</div></div><!-- fragment --><h1><a class="anchor" id="advMemAlloc_d"></a>
Static allocator</h1>
<p><a class="el" href="classbs_1_1_static_alloc.html">StaticAlloc&lt;BlockSize, MaxDynamicMemory&gt;</a> is a specialized type of allocator that can be used for permanent allocations. It works by pre-allocating a user-defined number of bytes. It then tries to use this pre-allocated buffer for any allocations requested from it. As long as the number of allocated bytes doesn't exceed the size of the pre-allocated buffer, allocations are basically free. If you exceed the size of the pre-allocated buffer the allocator will fall back on dynamic allocations.</p>
<p>The downside of this allocator is that the pre-allocated buffer will be using up memory, whether that memory is is actually required or not. Therefore it is important to predict a good static buffer size so that not much memory is wasted, and that most objects don't exceed the static buffer size. This kind of allocator is mostly useful when you have many relatively small objects, each of which requires dynamic allocation of a different size.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyObj</div><div class="line">{</div><div class="line">    StaticAlloc&lt;512&gt; mAlloc; <span class="comment">// Ensures that every instance of this object has 512 bytes pre-allocated</span></div><div class="line">    UINT8* mData = <span class="keyword">nullptr</span>;</div><div class="line"></div><div class="line">    MyObj(<span class="keywordtype">int</span> size)</div><div class="line">    {</div><div class="line">        <span class="comment">// As long as size doesn&#39;t go over 512 bytes, no dynamic allocations will be made</span></div><div class="line">        mData = mAlloc.alloc(size);</div><div class="line">    }</div><div class="line"></div><div class="line">    ~MyObj()</div><div class="line">    {</div><div class="line">        mAlloc.free(mData);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
    <!-- Footer -->
    <div class="myFooter">
		<div class="ui inverted vertical footer segment" style="border-top: 2px solid #f9500d;">
			<div class="ui container">
				<div class="ui stackable inverted divided equal height grid">
					<div class="three wide column">
						<h4 class="ui inverted header">Contact</h4>
						<div class="ui inverted link list">
							<a href="mailto:contact@bsframework.io" class="item">Contact us</a>
							<a href="https://github.com/GameFoundry/bsf/issues" target="_blank" class="item">Report an issue</a>
						</div>
					</div>
					<div class="three wide column">
						<h4 class="ui inverted header">Info</h4>
						<div class="ui inverted link list">
							<a href="https://github.com/GameFoundry/bsf" target="_blank" class="item">Contribute</a>
							<a href="https://github.com/GameFoundry/bsf/blob/master/Documentation/GitHub/roadmap.md" target="_blank" class="item">Roadmap</a>
							<a href="https://github.com/GameFoundry/bsf/blob/master/LICENSE.md" target="_blank" class="item">License</a>
						</div>
					</div>
					<div class="seven wide column">
						<h4 class="ui inverted header">Donate</h4>
						<div class="ui horizontal list">
							<div class="item"><a href="https://www.patreon.com/bsf"><img class="ui image" src="become_a_patron_button.png"></a></div>
							<div class="item"><a href="https://www.paypal.me/MarkoPintera/10" target="_blank"><img class="ui image" src="paypalDonate.png"></a></div>
						</div>
						<p style="padding-top:7px"><i>bs::f</i> is developed by Marko Pintera and contributors.</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div> <!-- Everything -->
</body>
</html>
